# file: roles/kafka_common/tasks/main.yaml

#   ___  ____       ____  ____  _____ ____ ___ _____ ___ ____
#  / _ \/ ___|     / ___||  _ \| ____/ ___|_ _|  ___|_ _/ ___|
# | | | \___ \ ____\___ \| |_) |  _|| |    | || |_   | | |
# | |_| |___) |_____|__) |  __/| |__| |___ | ||  _|  | | |___
#  \___/|____/     |____/|_|   |_____\____|___|_|   |___\____|
#
- include_tasks: ubuntu.yaml
  when: ansible_distribution == "Ubuntu"
  tags:
  - unbound

- include_tasks: centos.yaml
  when: ansible_distribution == "CentOS"
  tags:
  - unbound


#  _  __    _    _____ _  __    _       ____ ___  __  __ __  __  ___  _   _
# | |/ /   / \  |  ___| |/ /   / \     / ___/ _ \|  \/  |  \/  |/ _ \| \ | |
# | ' /   / _ \ | |_  | ' /   / _ \   | |  | | | | |\/| | |\/| | | | |  \| |
# | . \  / ___ \|  _| | . \  / ___ \  | |__| |_| | |  | | |  | | |_| | |\  |
# |_|\_\/_/   \_\_|   |_|\_\/_/   \_\  \____\___/|_|  |_|_|  |_|\___/|_| \_|
#
- name: Create the /var/tmp/ansible directory
  file:
    path: /var/tmp/ansible
    owner: root
    group: root
    mode: 0700
    state: directory

- name: Add the kafka group
  group:
    name: kafka
    gid: 320
    state: present

- name: Add the kafka user
  user:
    name: kafka
    uid: 320
    group: kafka
    create_home: no
    shell: /usr/sbin/nologin
    state: present

- name: Install kafka
  block:
  - debug:
      msg: Check whether the kafka {{ kafka_version }} package has been installed

  https://downloads.apache.org/kafka/2.5.0/kafka_2.13-2.5.0.tgz


  - stat:
      path: /bin/kafka
    register: kafka_installed_stat_result

  - shell:
      cmd: /bin/kafka --version | head -n1 | awk  {'print $3'}
    register: kafka_installed_version_output
    when: (kafka_installed_stat_result.stat.exists == True)

  - set_fact:
      kafka_installed_version: '{{ kafka_installed_version_output.stdout }}'
    when: (kafka_installed_stat_result.stat.exists == True)

  - set_fact:
      kafka_installed_version: ''
    when: (kafka_installed_stat_result.stat.exists == False)

  - block:
    - debug:
        msg: Install the kafka {{ kafka_version }} package

    - name: Check whether the kafka {{ kafka_version }} package has been downloaded
      become: no
      local_action: stat path=packages/kafka-v{{ kafka_version }}-linux-amd64.tar.gz
      register: kafka_package_stat_result

    - name: Download the kafka {{ kafka_version }} package
      become: no
      local_action: get_url url='https://github.com/kafka-io/kafka/releases/download/v{{ kafka_version }}/kafka-v{{ kafka_version }}-linux-amd64.tar.gz' dest='packages/kafka-v{{ kafka_version }}-linux-amd64.tar.gz' checksum={{ kafka_package_checksum }}
      when: (kafka_package_stat_result.stat.exists == False)
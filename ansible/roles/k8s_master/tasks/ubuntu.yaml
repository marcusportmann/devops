---
# file: roles/k8s_master/tasks/ubuntu.yaml

#  _____ ___ ____  _______        ___    _     _       ____   ___  ____ _____ ____
# |  ___|_ _|  _ \| ____\ \      / / \  | |   | |     |  _ \ / _ \|  _ \_   _/ ___|
# | |_   | || |_) |  _|  \ \ /\ / / _ \ | |   | |     | |_) | | | | |_) || | \___ \
# |  _|  | ||  _ <| |___  \ V  V / ___ \| |___| |___  |  __/| |_| |  _ < | |  ___) |
# |_|   |___|_| \_\_____|  \_/\_/_/   \_\_____|_____| |_|    \___/|_| \_\|_| |____/
#

# TODO: HOW DO WE ENABLE MASQUERADING?
#- name: Enable IP masquerade on the firewall
#  firewalld:
#    masquerade: 'yes'
#    state: enabled
#    permanent: yes

- name: Allow all hosts access to tcp port 2379
  community.general.ufw:
    rule: allow
    port: '2379'
    proto: tcp

- name: Allow all hosts access to tcp port 2380
  community.general.ufw:
    rule: allow
    port: '2380'
    proto: tcp

- name: Allow all hosts access to tcp port 4149 (Default cAdvisor port used to query container metrics)
  community.general.ufw:
    rule: allow
    port: '4149'
    proto: tcp

- name: Allow all hosts access to tcp port 6443 (Kubernetes API)
  community.general.ufw:
    rule: allow
    port: '6443'
    proto: tcp

- name: Allow all hosts access to tcp port 9100 (Prometheus Node Exporter)
  community.general.ufw:
    rule: allow
    port: '9100'
    proto: tcp

- name: Allow all hosts access to tcp port 10250 (API which allows full node access)
  community.general.ufw:
    rule: allow
    port: '10250'
    proto: tcp

- name: Allow all hosts access to tcp port 10251
  community.general.ufw:
    rule: allow
    port: '10251'
    proto: tcp

- name: Allow all hosts access to tcp port 10252
  community.general.ufw:
    rule: allow
    port: '10252'
    proto: tcp

- name: Allow all hosts access to tcp port 10255 (Unauthenticated read-only port, allowing access to node state)
  community.general.ufw:
    rule: allow
    port: '10255'
    proto: tcp

# TODO: CHECK THIS PORT
- name: Allow all hosts access to tcp port 10256 (Health check server for Kube Proxy)
  community.general.ufw:
    rule: allow
    port: '10256'
    proto: tcp

# TODO: CHECK THIS PORT
- name: Allow all hosts access to tcp port 10257 (Kube Controller Manager Port)
  community.general.ufw:
    rule: allow
    port: '10257'
    proto: tcp

- name: Allow all hosts access to tcp ports 30000-32767 (Nodeport)
  community.general.ufw:
    rule: allow
    port: 30000:32767
    proto: tcp




- name: Open ports for the Weave CNI provider
  block:
  - name: Allow all hosts access to tcp port 6783 for the Weave CNI provider
    community.general.ufw:
      rule: allow
      port: '6783'
      proto: tcp

  - name: Allow all access to udp port 6783 for the Weave CNI provider
    community.general.ufw:
      rule: allow
      port: '6783'
      proto: udp

  - name: Allow all access to tcp port 6784 for the Weave CNI provider
    community.general.ufw:
      rule: allow
      port: '6784'
      proto: tcp

  - name: Allow all access to udp port 6784 for the Weave CNI provider
    community.general.ufw:
      rule: allow
      port: '6784'
      proto: udp

  when: (k8s_config.cni_provider == 'weave')


- name: Open ports for the Flannel CNI provider
  block:
  - name: Allow all hosts access to udp port 8285 for the Flannel CNI provider
    community.general.ufw:
      rule: allow
      port: '8285'
      proto: udp

  - name: Allow all access to udp port 8472 for the Flannel CNI provider
    community.general.ufw:
      rule: allow
      port: '8472'
      proto: udp

  when: (k8s_config.cni_provider == 'flannel')






